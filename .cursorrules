# Amor — Cursor Rules

You are working on **Amor**, a social PWA for users aged 6–21. Before making any changes, read `PROJECT.md` in the project root for full architecture, design system, and feature documentation.

## Project Context

- **Type:** Progressive Web App (single-page), deployed on Vercel
- **Framework:** Next.js 16 (App Router), TypeScript, React 19
- **Styling:** Tailwind CSS v4 with custom design system in `app/globals.css`
- **State:** Zustand stores in `lib/stores/`
- **Backend:** Supabase (Auth, PostgreSQL, Realtime, Presence, Storage, Edge Functions)
- **Voice:** LiveKit Cloud for Discord-style voice rooms
- **Language:** UI is in Russian (ru). Code comments and variable names in English.
- **Production URL:** https://amor-app-gamma.vercel.app/

## Architecture Rules

### Routing
- This is a **single-page app**. All routing is managed by `app/page.tsx` via a `phase` state machine: `null → intro → auth → onboarding → main`.
- Do NOT create new pages under `app/`. All screens are components in `components/amor/`.
- The only server route is `app/auth/callback/route.ts` for Supabase PKCE redirects.

### State Management
- All state goes through **Zustand stores** in `lib/stores/`. Never use React Context or prop drilling for shared state.
- Stores: `auth`, `profile`, `match`, `chat`, `rooms`, `quests`, `characters`, `stars`, `notifications`, `presence`, `promo`.
- Each store creates a Supabase client via `createClient()` from `lib/supabase/client.ts` (singleton).
- `auth` store: Email OTP sign-in, Russian error messages via `mapAuthError()`, resend cooldown (60s).
- `profile` store: `profileLoaded` flag distinguishes "not loaded yet" from "doesn't exist". Has `uploadAvatar()`, `uploadPhoto()`, `uploadBanner()`, `uploadVoiceBio()`, `removePhoto()`, `reset()` methods.
- `chat` store: Optimistic message insert with temp IDs. Realtime subscriptions for INSERT and UPDATE (read receipts). Typing indicator via Broadcast. `sendImage()` compresses before upload. `sendVoice()` for voice messages.
- `match` store: Skip cooldown — skipped users reappear after 2 days. Likes/superlikes excluded permanently. Throttle on swipe actions (400ms).
- `notifications` store: Aggregates matches + unread messages. Read state persisted via localStorage (`amor_notif_seen`). Realtime subscription for new matches/messages.
- `presence` store: Supabase Realtime Presence. Tracks online users via `amor-presence` channel. Auto-disconnect on logout/close.

### Supabase
- Browser client: `lib/supabase/client.ts` — singleton, used in all stores and client components.
- Server client: `lib/supabase/server.ts` — used in server components and route handlers.
- Database types: `lib/supabase/database.types.ts` — must stay in sync with the schema.
- Schema: `supabase/migrations/001_initial_schema.sql` — base schema. `002_add_music_columns.sql` — patches for existing DBs.
- RLS is enabled on ALL tables. Every query runs as the authenticated user.
- Storage buckets: `avatars` (profile photos + banners), `voice-bios` (voice bio recordings), `chat-media` (photos + voice messages in chats).
- Storage RLS policies allow authenticated upload to all buckets, public read.
- Realtime subscriptions: `messages` (INSERT + UPDATE), `room_messages`, `room_members`, `matches`.

### File Organization
```
components/amor/    → Feature screens and UI components
components/ui/      → shadcn/ui primitives (do not modify)
lib/stores/         → Zustand stores (one per domain)
lib/supabase/       → Supabase client helpers and database.types.ts
lib/sanitize.ts     → Input sanitization (stripTags, message/name/bio limits)
lib/compress-image.ts → Client-side JPEG compression (max 1200px, quality 0.7)
supabase/functions/ → Deno Edge Functions
supabase/migrations/→ SQL schema + patches
public/sw.js        → Service Worker (disabled on localhost)
public/manifest.json→ PWA manifest
```

### Safe Area (Notched Phones)
- CSS variables `--sat` and `--sab` map to `env(safe-area-inset-top/bottom)`.
- `--topbar-h = calc(56px + --sat)`, `--bottomnav-h = calc(68px + --sab)`.
- All tab screens use `style={{ paddingTop: "var(--topbar-h)" }}` instead of `pt-14`.
- All modal headers use `style={{ paddingTop: "calc(var(--sat) + 12px)" }}`.
- TopBar: `style={{ paddingTop: "var(--sat)" }}`.
- BottomNav: `style={{ paddingBottom: "var(--sab)" }}`.
- Chat input: `style={{ paddingBottom: "calc(var(--sab) + 12px)" }}`.
- Viewport: `viewport-fit: cover` in `layout.tsx`.

### Key Component Files
- `vibe-screen.tsx` — Full-bleed swipe cards. Touch + mouse drag. Tap left/right to switch photos. Details modal overlay. Character full-body display (35% opacity). Fallback for no-photo users.
- `chat-screen.tsx` — Chat list with search, unread badges, online dots. Inside chat: text, image, voice messages. Read receipts (Check/CheckCheck). Typing indicator. Voice recording. Image compression. User profile preview modal.
- `edit-profile-screen.tsx` — Photo grid (6 max), banner picker (10 presets + custom upload), bio, interests, music DNA. `getBannerStyle()` exported for profile-screen.
- `shop-screen.tsx` — Free chest with 72h timer, video placeholder, drop rates visualization, character grid with % chances, promo code input.
- `box-opening-screen.tsx` — 4-phase gacha animation with rarity-specific VFX (Mythic: rumble + confetti + rays; Legendary: surge + scanlines; Epic: aura + pulse; Rare: simple reveal).
- `pwa-install-prompt.tsx` — PWA install instructions for iOS/Android/desktop. Shows once, dismissed via localStorage.

## Coding Standards

### TypeScript
- Strict mode enabled. No `any` unless absolutely necessary (DB queries are an exception).
- Use `interface` for component props, `type` for unions and utility types.
- Import types with `import type` when possible.

### React
- All components are client components (`"use client"` directive).
- Use `useEffect` for side effects, `useCallback` for stable references, `useMemo` for expensive computations.
- Do NOT use `React.FC`. Use plain function declarations with typed props.
- Prefer `cn()` from `lib/utils` for conditional class composition.

### Security
- Input sanitization via `lib/sanitize.ts`: `sanitizeMessage()`, `sanitizeName()`, `sanitizeBio()` — strips HTML tags, enforces length limits.
- Image compression via `lib/compress-image.ts` — JPEG, max 1200px, quality 0.7.
- DB constraints enforce max lengths: messages 2000, name 30, bio 200.
- Swipe throttle: 400ms between swipes to prevent double-tap.
- All storage uploads use unique paths with timestamps + random suffixes for cache-busting.

### Styling
- Use Tailwind CSS utility classes. Custom CSS is in `app/globals.css`.
- The design is **always dark theme** — `:root` in `app/globals.css` defines dark colors directly.
- Custom classes: `glass`, `glass-raised`, `glass-strong`, `grad-pink/cyan/sunset/gold/purple`, `glow-*`, `text-grad-*`, `anim-*`, `banner-*`.
- Card radius: `var(--card-r)` (20px), `var(--card-r-lg)` (24px).
- Layout: `var(--topbar-h)`, `var(--bottomnav-h)`, `var(--screen-px)` (16px).

### Naming
- Component files: `kebab-case.tsx`
- Store files: `kebab-case.ts`
- Functions/variables: `camelCase`
- CSS classes: `kebab-case`
- DB tables: `snake_case`

### Error Handling
- Supabase queries: always destructure `{ data, error }`. Log errors with `console.warn`.
- User-facing errors: show in UI with auto-dismiss (3-4 seconds).
- All async store methods wrapped in try/catch.

## Z-index Layers
- `z-40` — TopBar
- `z-50` — BottomNav
- `z-60` — Chat overlay
- `z-100` — Full-screen modals (auth, onboarding, settings, shop, quests, notifications, edit-profile)
- `z-150` — User profile preview in chat
- `z-200` — Box opening animation, image viewer
- `z-300` — PWA install prompt

## Do NOT

- Do NOT modify `components/ui/` files (shadcn primitives)
- Do NOT create new pages in `app/` (single-page architecture)
- Do NOT use React Context for state (use Zustand)
- Do NOT hardcode Supabase URLs or keys (use env vars)
- Do NOT skip RLS when adding tables
- Do NOT use `styles/globals.css` — it's a leftover, use `app/globals.css`
- Do NOT use `<audio>` elements for playback — use AudioContext API
- Do NOT use `className="hidden"` on `<input type="file">` — use transparent overlay pattern
- Do NOT use `pt-14` for topbar offset — use `style={{ paddingTop: "var(--topbar-h)" }}`
- Do NOT use hardcoded safe area values — use CSS vars `--sat`, `--sab`
- Do NOT store user input without sanitization — use `lib/sanitize.ts`
